name: Sync Upstream

on:
  schedule:
    # æ¯7å¤©åŒ—äº¬æ—¶é—´ 9:00 (UTC 1:00) æ£€æŸ¥æ›´æ–°
    - cron: '0 1 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    name: Sync Upstream Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

      - name: Configure Git with PAT
        run: |
          if [ -n "${{ secrets.GH_PAT }}" ]; then
            echo "âœ… GH_PAT secret is set, configuring origin URL..."
            git remote set-url origin "https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git"
            echo "Origin URL configured:"
            git remote -v
          else
            echo "âš ï¸  WARNING: GH_PAT secret is not set!"
            echo "Please create a Personal Access Token and add it as GH_PAT secret."
            echo "Visit: https://github.com/EightDoor/siyuan/settings/secrets/actions"
            echo "Continuing without PAT (will fail if pushing workflow files)..."
          fi

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/siyuan-note/siyuan.git
          git fetch upstream

      - name: Check for updates
        id: check_updates
        run: |
          echo "Checking for updates from upstream..."
          UPSTREAM_LATEST=$(git rev-parse upstream/master)
          CURRENT=$(git rev-parse origin/master)

          if [ "$UPSTREAM_LATEST" = "$CURRENT" ]; then
            echo "âœ… Already up to date"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ New commits found"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "upstream_latest=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
            echo "current=$CURRENT" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        id: merge
        if: steps.check_updates.outputs.needs_sync == 'true'
        run: |
          echo "Attempting to merge upstream/master into master..."
          if git merge upstream/master -m "Merge upstream/master at $(date +'%Y-%m-%d %H:%M:%S UTC')" --no-edit; then
            echo "âœ… Merge successful"
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Merge conflict detected"
            echo "merge_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Push changes
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          # ä½¿ç”¨ PAT è¿›è¡Œè®¤è¯ï¼Œä»¥ç¡®ä¿æœ‰ workflow æƒé™
          git push "https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git" master

      - name: Get latest upstream tag
        if: steps.merge.outputs.merge_success == 'true'
        id: get_tag
        run: |
          # è·å–æœ€æ–°çš„ä¸Šæ¸¸æ­£å¼ç‰ˆæœ¬ tagï¼ˆæ’é™¤ -dev, -beta, -rc ç­‰åç¼€ï¼‰
          LATEST_TAG=$(git tag -l "v*" --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)
          
          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ­£å¼ç‰ˆæœ¬ï¼Œåˆ™è·³è¿‡åç»­å¤„ç†
          if [ -z "$LATEST_TAG" ]; then
            echo "â„¹ï¸  No stable release tag found, skipping tag sync..."
            echo "latest_tag=none" >> $GITHUB_OUTPUT
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "tag_needs_update=false" >> $GITHUB_OUTPUT
            echo "is_stable_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Latest upstream stable tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "is_stable_release=true" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥è¯¥ tag æ˜¯å¦å·²å­˜åœ¨äºè¿œç¨‹ä»“åº“
          echo "Checking if tag exists in remote..."
          if git ls-remote --tags origin | grep -q "refs/tags/$LATEST_TAG$"; then
            echo "âœ… Tag $LATEST_TAG exists in remote"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            
            # è·å–è¿œç¨‹ tag æŒ‡å‘çš„ commit
            REMOTE_TAG_COMMIT=$(git ls-remote --tags origin | grep "refs/tags/$LATEST_TAG$" | awk '{print $1}')
            echo "Remote tag $LATEST_TAG points to commit: $REMOTE_TAG_COMMIT"
            
            # è·å–å½“å‰ HEAD commit
            CURRENT_HEAD=$(git rev-parse HEAD)
            echo "Current HEAD commit: $CURRENT_HEAD"
            
            # æ£€æŸ¥ tag æ˜¯å¦æŒ‡å‘å½“å‰ HEAD
            if [ "$REMOTE_TAG_COMMIT" = "$CURRENT_HEAD" ]; then
              echo "âœ… Tag $LATEST_TAG already points to current HEAD"
              echo "tag_needs_update=false" >> $GITHUB_OUTPUT
              echo "tag_points_to_head=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Tag $LATEST_TAG points to old commit ($REMOTE_TAG_COMMIT)"
              echo "tag_needs_update=true" >> $GITHUB_OUTPUT
              echo "tag_points_to_head=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âœ… Tag $LATEST_TAG does not exist in remote, will create..."
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "tag_needs_update=false" >> $GITHUB_OUTPUT
            echo "tag_points_to_head=false" >> $GITHUB_OUTPUT
          fi

      - name: Check if release exists
        if: steps.get_tag.outputs.latest_tag != 'none' && steps.get_tag.outputs.is_stable_release == 'true'
        id: check_release
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          echo "Checking if release exists for tag $LATEST_TAG..."
          
          # ä½¿ç”¨ GitHub API æ£€æŸ¥ release æ˜¯å¦å­˜åœ¨
          RELEASE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$LATEST_TAG")
          
          if echo "$RELEASE_RESPONSE" | grep -q '"tag_name"'; then
            echo "âš ï¸  Release for tag $LATEST_TAG already exists, skipping..."
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Release for tag $LATEST_TAG does not exist, will create..."
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Push or update tag to origin
        id: push_tag
        if: steps.check_release.outputs.release_exists == 'false'
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          TAG_EXISTS="${{ steps.get_tag.outputs.tag_exists }}"
          TAG_NEEDS_UPDATE="${{ steps.get_tag.outputs.tag_needs_update }}"
          TAG_POINTS_TO_HEAD="${{ steps.get_tag.outputs.tag_points_to_head }}"
          
          echo "Processing tag $LATEST_TAG..."
          echo "Tag exists: $TAG_EXISTS"
          echo "Tag needs update: $TAG_NEEDS_UPDATE"
          echo "Tag points to HEAD: $TAG_POINTS_TO_HEAD"
          
          # æƒ…å†µ 1ï¼štag ä¸å­˜åœ¨ â†’ åˆ›å»ºå¹¶æ¨é€æ–° tag
          if [ "$TAG_EXISTS" == "false" ]; then
            echo ""
            echo "=== Creating new tag $LATEST_TAG ==="
            
            # å‰é¢å·²ç» git fetch upstreamï¼Œæ ‡ç­¾å·²åœ¨æœ¬åœ°
            # ç›´æ¥ä½¿ç”¨ä¸Šæ¸¸æ ‡ç­¾æŒ‡å‘çš„ commit åˆ›å»ºæœ¬åœ°æ ‡ç­¾
            UPSTREAM_COMMIT=$(git rev-parse refs/tags/$LATEST_TAG)
            echo "Upstream tag $LATEST_TAG points to commit: $UPSTREAM_COMMIT"
            
            echo "Creating local tag $LATEST_TAG at commit $UPSTREAM_COMMIT..."
            git tag -f "$LATEST_TAG" "$UPSTREAM_COMMIT"
            
            echo "Pushing tag $LATEST_TAG to origin..."
            if git push "https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git" "$LATEST_TAG"; then
              echo "âœ… Tag $LATEST_TAG pushed successfully, this will trigger build workflow"
              echo "tag_action=created" >> $GITHUB_OUTPUT
              echo "tag_success=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Failed to push tag $LATEST_TAG due to permission restrictions"
              echo "tag_success=false" >> $GITHUB_OUTPUT
              echo "Manual push required: git push origin $LATEST_TAG"
              exit 0
            fi
          
          # æƒ…å†µ 2ï¼štag å­˜åœ¨ä½†æŒ‡å‘æ—§ commit â†’ åˆ é™¤å¹¶é‡æ–°åˆ›å»º
          elif [ "$TAG_NEEDS_UPDATE" == "true" ]; then
            echo ""
            echo "=== Updating existing tag $LATEST_TAG ==="
            
            # è·å–å½“å‰ HEAD commit
            CURRENT_HEAD=$(git rev-parse HEAD)
            echo "Current HEAD: $CURRENT_HEAD"
            
            # åˆ é™¤æœ¬åœ° tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            echo "Deleting local tag $LATEST_TAG if exists..."
            git tag -d "$LATEST_TAG" 2>/dev/null || true
            
            # åŸºäº HEAD åˆ›å»ºæœ¬åœ° tag
            echo "Creating local tag $LATEST_TAG at HEAD ($CURRENT_HEAD)..."
            git tag -f "$LATEST_TAG" "$CURRENT_HEAD"
            
            # åˆ é™¤è¿œç¨‹ tag
            echo "Deleting remote tag $LATEST_TAG..."
            if git push "https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git" --delete "refs/tags/$LATEST_TAG"; then
              echo "âœ… Remote tag $LATEST_TAG deleted"
            else
              echo "âš ï¸  Failed to delete remote tag, will try force push"
            fi
            
            # å¼ºåˆ¶æ¨é€æ–° tag
            echo "Force pushing tag $LATEST_TAG to origin..."
            if git push "https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git" "$LATEST_TAG" --force; then
              echo "âœ… Tag $LATEST_TAG updated successfully, this will trigger build workflow"
              echo "tag_action=updated" >> $GITHUB_OUTPUT
              echo "tag_success=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Failed to update tag $LATEST_TAG due to permission restrictions"
              echo "tag_success=false" >> $GITHUB_OUTPUT
              echo "Manual update required:"
              echo "  git tag -d $LATEST_TAG"
              echo "  git tag $LATEST_TAG HEAD"
              echo "  git push origin $LATEST_TAG --force"
              exit 0
            fi
          
          # æƒ…å†µ 3ï¼štag å­˜åœ¨ä¸”æŒ‡å‘ HEADï¼Œä½† release ä¸å­˜åœ¨ â†’ å¼ºåˆ¶æ¨é€è§¦å‘æ„å»º
          elif [ "$TAG_POINTS_TO_HEAD" == "true" ]; then
            echo ""
            echo "=== Tag $LATEST_TAG already points to HEAD, force push to trigger build ==="
            
            if git push "https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git" "$LATEST_TAG" --force; then
              echo "âœ… Tag $LATEST_TAG force pushed successfully, this will trigger build workflow"
              echo "tag_action=forced" >> $GITHUB_OUTPUT
              echo "tag_success=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  Failed to force push tag $LATEST_TAG due to permission restrictions"
              echo "tag_success=false" >> $GITHUB_OUTPUT
              echo "Manual force push required: git push origin $LATEST_TAG --force"
              exit 0
            fi
          
          # æƒ…å†µ 4ï¼šä¸åº”è¯¥åˆ°è¾¾è¿™é‡Œ
          else
            echo "âŒ Unexpected tag state, skipping"
            echo "tag_action=skipped" >> $GITHUB_OUTPUT
            echo "tag_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Get current time
        id: time
        run: |
          echo "datetime=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

      - name: Send email notification on success
        if: steps.merge.outputs.merge_success == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… SiYuan ä»£ç åŒæ­¥æˆåŠŸ - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            ä»£ç å·²æˆåŠŸä»ä¸Šæ¸¸åŒæ­¥ï¼
            
            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            åŠ¨ä½œ: åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯
            
            Tag çŠ¶æ€:
            ${{ steps.get_tag.outputs.latest_tag == 'none' && 'æœªæ£€æµ‹åˆ°æ­£å¼ç‰ˆæœ¬ tag' || steps.check_release.outputs.release_exists == 'true' && format('æ­£å¼ç‰ˆæœ¬ {0} çš„ Release å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º', steps.get_tag.outputs.latest_tag) || format('æ­£å¼ç‰ˆæœ¬ {0} çš„å¤„ç†ç»“æœ:', steps.get_tag.outputs.latest_tag) }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.push_tag.outputs.tag_action == 'created' && format('ğŸ‰ å·²åˆ›å»ºæ–° tag {0} å¹¶æ¨é€ï¼Œå°†è§¦å‘æ„å»º', steps.get_tag.outputs.latest_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.push_tag.outputs.tag_action == 'updated' && format('ğŸ”„ å·²æ›´æ–° tag {0} æŒ‡å‘æœ€æ–°ä»£ç ï¼Œå°†è§¦å‘æ„å»º', steps.get_tag.outputs.latest_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.push_tag.outputs.tag_action == 'forced' && format('âœ… å·²å¼ºåˆ¶æ¨é€ tag {0} è§¦å‘æ„å»º', steps.get_tag.outputs.latest_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.push_tag.outputs.tag_success == 'false' && format('âš ï¸ Tag {0} æ“ä½œå¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†', steps.get_tag.outputs.latest_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.push_tag.outputs.tag_success == 'false' && format('æ‰‹åŠ¨æ“ä½œå‘½ä»¤:', steps.get_tag.outputs.latest_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.push_tag.outputs.tag_action == 'updated' && steps.push_tag.outputs.tag_success == 'false' && format('  git tag -d {0}', steps.get_tag.outputs.latest_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.push_tag.outputs.tag_action == 'updated' && steps.push_tag.outputs.tag_success == 'false' && format('  git tag {0} HEAD', steps.get_tag.outputs.latest_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.push_tag.outputs.tag_success == 'false' && format('  git push origin {0} --force', steps.get_tag.outputs.latest_tag) || '' }}
            
            æŸ¥çœ‹è¯¦æƒ…: https://github.com/EightDoor/siyuan/commits/master
            
            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: Send email notification on conflict
        if: failure() && steps.merge.outputs.merge_success == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ SiYuan ä»£ç åŒæ­¥å†²çª - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            âš ï¸ ä»£ç åŒæ­¥æ—¶æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†ï¼

            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            é—®é¢˜: åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯æ—¶å‘ç”Ÿå†²çª

            è¯·å°½å¿«æ‰‹åŠ¨è§£å†³å†²çªï¼š
            1. git fetch upstream
            2. git merge upstream/master
            3. è§£å†³å†²çª
            4. git push origin master

            æŸ¥çœ‹è¯¦æƒ…: https://github.com/EightDoor/siyuan/actions

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: Send email notification on error
        if: failure() && steps.merge.outputs.merge_success != 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âš ï¸ SiYuan ä»£ç åŒæ­¥å¤±è´¥ - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            ä»£ç åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼

            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan

            è¯·æ£€æŸ¥æ—¥å¿—: https://github.com/EightDoor/siyuan/actions

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
