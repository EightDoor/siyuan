name: Sync Upstream

on:
  schedule:
    # æ¯7å¤©åŒ—äº¬æ—¶é—´ 9:00 (UTC 1:00) æ£€æŸ¥æ›´æ–°
    - cron: '0 1 * * 0'
  workflow_dispatch:

jobs:
  sync:
    name: Sync Upstream Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/siyuan-note/siyuan.git
          git fetch upstream

      - name: Check for updates
        id: check_updates
        run: |
          echo "Checking for updates from upstream..."
          UPSTREAM_LATEST=$(git rev-parse upstream/master)
          CURRENT=$(git rev-parse origin/master)

          if [ "$UPSTREAM_LATEST" = "$CURRENT" ]; then
            echo "âœ… Already up to date"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ New commits found"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "upstream_latest=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
            echo "current=$CURRENT" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        id: merge
        if: steps.check_updates.outputs.needs_sync == 'true'
        run: |
          echo "Attempting to merge upstream/master into master..."
          if git merge upstream/master -m "Merge upstream/master at $(date +'%Y-%m-%d %H:%M:%S UTC')" --no-edit; then
            echo "âœ… Merge successful"
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Merge conflict detected"
            echo "merge_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Push changes
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          git push origin master

      - name: Get latest upstream tag
        if: steps.merge.outputs.merge_success == 'true'
        id: get_tag
        run: |
          # è·å–æœ€æ–°çš„ upstream tag
          LATEST_TAG=$(git tag -l "v*" --sort=-version:refname | head -n1)
          echo "Latest upstream tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # æ£€æŸ¥è¯¥ tag æ˜¯å¦å·²å­˜åœ¨äºè¿œç¨‹ä»“åº“
          echo "Checking if tag exists in remote..."
          if git ls-remote --tags origin | grep -q "refs/tags/$LATEST_TAG$"; then
            echo "âš ï¸  Tag $LATEST_TAG already exists in remote, skipping..."
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag $LATEST_TAG does not exist in remote, will push..."
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Push new tag to origin
        if: steps.get_tag.outputs.tag_exists == 'false'
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          echo "Fetching tag $LATEST_TAG from upstream..."
          git fetch upstream tag "$LATEST_TAG" --no-tags

          echo "Creating local tag $LATEST_TAG..."
          git tag "$LATEST_TAG" "$LATEST_TAG^{}"

          echo "Pushing tag $LATEST_TAG to origin..."
          git push origin "$LATEST_TAG"

          echo "âœ… Tag $LATEST_TAG pushed successfully"

      - name: Get current time
        id: time
        run: |
          echo "datetime=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Send email notification on success
        if: steps.merge.outputs.merge_success == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… SiYuan ä»£ç åŒæ­¥æˆåŠŸ - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            ä»£ç å·²æˆåŠŸä»ä¸Šæ¸¸åŒæ­¥ï¼

            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            åŠ¨ä½œ: åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯

            Tag çŠ¶æ€:
            ${{ steps.get_tag.outputs.tag_exists == 'true' && format('æœ€æ–° tag {0} å·²å­˜åœ¨ï¼Œè·³è¿‡æ¨é€', steps.get_tag.outputs.latest_tag) || format('âœ… æœ€æ–° tag {0} å·²æˆåŠŸæ¨é€', steps.get_tag.outputs.latest_tag) }}

            æŸ¥çœ‹è¯¦æƒ…: https://github.com/EightDoor/siyuan/commits/master

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: Send email notification on conflict
        if: failure() && steps.merge.outputs.merge_success == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ SiYuan ä»£ç åŒæ­¥å†²çª - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            âš ï¸ ä»£ç åŒæ­¥æ—¶æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†ï¼

            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            é—®é¢˜: åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯æ—¶å‘ç”Ÿå†²çª

            è¯·å°½å¿«æ‰‹åŠ¨è§£å†³å†²çªï¼š
            1. git fetch upstream
            2. git merge upstream/master
            3. è§£å†³å†²çª
            4. git push origin master

            æŸ¥çœ‹è¯¦æƒ…: https://github.com/EightDoor/siyuan/actions

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: Send email notification on error
        if: failure() && steps.merge.outputs.merge_success != 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âš ï¸ SiYuan ä»£ç åŒæ­¥å¤±è´¥ - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            ä»£ç åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼

            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan

            è¯·æ£€æŸ¥æ—¥å¿—: https://github.com/EightDoor/siyuan/actions

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
