name: Sync Upstream

on:
  schedule:
    # æ¯7å¤©åŒ—äº¬æ—¶é—´ 9:00 (UTC 1:00) æ£€æŸ¥æ›´æ–°
    - cron: '0 1 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    name: Sync Upstream Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/siyuan-note/siyuan.git
          git fetch upstream

      - name: Check for updates
        id: check_updates
        run: |
          echo "Checking for updates from upstream..."
          UPSTREAM_LATEST=$(git rev-parse upstream/master)
          CURRENT=$(git rev-parse origin/master)

          if [ "$UPSTREAM_LATEST" = "$CURRENT" ]; then
            echo "âœ… Already up to date"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ New commits found"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "upstream_latest=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
            echo "current=$CURRENT" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        id: merge
        if: steps.check_updates.outputs.needs_sync == 'true'
        run: |
          echo "Attempting to merge upstream/master into master..."
          if git merge upstream/master -m "Merge upstream/master at $(date +'%Y-%m-%d %H:%M:%S UTC')" --no-edit; then
            echo "âœ… Merge successful"
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Merge conflict detected"
            echo "merge_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Push changes
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          git push origin master

      - name: Get latest upstream tag
        if: steps.merge.outputs.merge_success == 'true'
        id: get_tag
        run: |
          echo "Fetching upstream version..."
          
          # è·å–æ‰€æœ‰ä¸Šæ¸¸tagså¹¶æ˜¾ç¤ºå‰20ä¸ªï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo ""
          echo "=== Latest upstream tags ==="
          git ls-remote --tags upstream | head -20
          echo ""
          
          # ä»ä¸Šæ¸¸è·å–æœ€æ–°çš„æ­£å¼ç‰ˆæœ¬tag
          # è¿‡æ»¤è§„åˆ™ï¼š
          # 1. åªåŒ¹é… v å¼€å¤´çš„tag
          # 2. ç‰ˆæœ¬æ ¼å¼ä¸º x.y.zï¼ˆå¦‚ v3.5.4ï¼‰
          # 3. æ’é™¤å¼€å‘ç‰ˆæœ¬ï¼ˆ-dev, -beta, -rc, -alpha, -pre ç­‰åç¼€ï¼‰
          UPSTREAM_TAG=$(git ls-remote --tags upstream | \
            grep -E 'refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$' | \
            grep -v -E '(dev|beta|rc|alpha|pre|snapshot)' | \
            awk '{print $2}' | \
            sed 's|refs/tags/||' | \
            sort -V | \
            tail -n 1)
          
          if [ -z "$UPSTREAM_TAG" ]; then
            echo "â„¹ï¸  No stable release tag found in upstream"
            echo "latest_tag=none" >> $GITHUB_OUTPUT
            echo "is_stable_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo ""
          echo "âœ… Found latest upstream stable tag: $UPSTREAM_TAG"
          echo "latest_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          echo "is_stable_release=true" >> $GITHUB_OUTPUT
          
          # æå–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION="${UPSTREAM_TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo ""
          
          # ç”Ÿæˆç§æœ‰tagåç§°
          PRIVATE_TAG="release-$VERSION"
          echo "private_tag=$PRIVATE_TAG" >> $GITHUB_OUTPUT
          echo "Private tag will be: $PRIVATE_TAG"

      - name: Check if release exists
        if: steps.get_tag.outputs.latest_tag != 'none' && steps.get_tag.outputs.is_stable_release == 'true'
        id: check_release
        run: |
          VERSION="${{ steps.get_tag.outputs.version }}"
          PRIVATE_TAG="${{ steps.get_tag.outputs.private_tag }}"
          
          echo "Checking if release exists for version $VERSION..."
          echo "Private tag: $PRIVATE_TAG"
          
          # æ£€æŸ¥è¯¥ç‰ˆæœ¬çš„ Release æ˜¯å¦å·²å­˜åœ¨
          # é€šè¿‡æŸ¥è¯¢æ‰€æœ‰ releases å¹¶åŒ¹é…ç‰ˆæœ¬å·
          RELEASES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          
          # æ£€æŸ¥æ˜¯å¦æœ‰åŒ¹é…ç‰ˆæœ¬çš„ releaseï¼ˆé€šè¿‡ name å­—æ®µï¼‰
          if echo "$RELEASES" | grep -q "\"name\": \"$VERSION\""; then
            echo "âš ï¸  Release for version $VERSION already exists, skipping..."
            echo "release_exists=true" >> $GITHUB_OUTPUT
            
            # è·å–è¯¥ release çš„ tag ä¿¡æ¯
            EXISTING_TAG=$(echo "$RELEASES" | jq -r ".[] | select(.name==\"$VERSION\") | .tag_name")
            echo "Existing release tag: $EXISTING_TAG"
            echo "existing_tag=$EXISTING_TAG" >> $GITHUB_OUTPUT
          else
            echo "âœ… Release for version $VERSION does not exist, will create..."
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create private tag and trigger build
        if: steps.check_release.outputs.release_exists == 'false'
        id: create_tag
        run: |
          VERSION="${{ steps.get_tag.outputs.version }}"
          PRIVATE_TAG="${{ steps.get_tag.outputs.private_tag }}"
          CURRENT_HEAD=$(git rev-parse HEAD)
          
          echo ""
          echo "=== Creating private tag: $PRIVATE_TAG ==="
          echo "Version: $VERSION (from upstream tag v$VERSION)"
          echo "Current HEAD: $CURRENT_HEAD"
          echo ""
          
          # åˆ é™¤æœ¬åœ°ç§æœ‰tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "Deleting local private tag if exists..."
          git tag -d "$PRIVATE_TAG" 2>/dev/null || true
          
          # åˆ›å»ºç§æœ‰tag
          echo "Creating private tag $PRIVATE_TAG at HEAD..."
          git tag "$PRIVATE_TAG" "$CURRENT_HEAD"
          
          # æ¨é€ç§æœ‰tagï¼ˆä½¿ç”¨ --force å¼ºåˆ¶æ¨é€ï¼‰
          echo "Force pushing private tag $PRIVATE_TAG to origin..."
          if git push origin "$PRIVATE_TAG" --force; then
            echo "âœ… Private tag $PRIVATE_TAG pushed successfully!"
            echo "CD workflow will be triggered shortly."
            echo "tag_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to push private tag $PRIVATE_TAG"
            echo "tag_success=false" >> $GITHUB_OUTPUT
            echo ""
            echo "Manual push required:"
            echo "  git tag $PRIVATE_TAG HEAD"
            echo "  git push origin $PRIVATE_TAG --force"
            exit 0
          fi

      - name: Get current time
        id: time
        run: |
          echo "datetime=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

      - name: Send email notification on success
        if: steps.merge.outputs.merge_success == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… SiYuan ä»£ç åŒæ­¥æˆåŠŸ - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            ä»£ç å·²æˆåŠŸä»ä¸Šæ¸¸åŒæ­¥ï¼
            
            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            åŠ¨ä½œ: åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯
            
            ç‰ˆæœ¬ä¿¡æ¯:
            ä¸Šæ¸¸æœ€æ–°tag: ${{ steps.get_tag.outputs.latest_tag }}
            ç‰ˆæœ¬å·: ${{ steps.get_tag.outputs.version }}
            ç§æœ‰tag: ${{ steps.get_tag.outputs.private_tag }}
            
            æ„å»ºçŠ¶æ€:
            ${{ steps.get_tag.outputs.latest_tag == 'none' && 'æœªæ£€æµ‹åˆ°æ­£å¼ç‰ˆæœ¬' || steps.check_release.outputs.release_exists == 'true' && format('âœ… ç‰ˆæœ¬ {0} çš„ Release å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º', steps.get_tag.outputs.version) || format('ğŸ‰ å°†åˆ›å»ºç§æœ‰ tag {0} å¹¶è§¦å‘æ„å»º', steps.get_tag.outputs.private_tag) }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.create_tag.outputs.tag_success == 'true' && format('âœ… ç§æœ‰ tag {0} å·²æ¨é€æˆåŠŸï¼ŒCD workflow å°†è‡ªåŠ¨è§¦å‘', steps.get_tag.outputs.private_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.create_tag.outputs.tag_success == 'false' && format('âš ï¸  ç§æœ‰ tag {0} æ¨é€å¤±è´¥', steps.get_tag.outputs.private_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.create_tag.outputs.tag_success == 'false' && format('æ‰‹åŠ¨æ“ä½œå‘½ä»¤:', steps.get_tag.outputs.version) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.create_tag.outputs.tag_success == 'false' && format('  git tag {0} HEAD', steps.get_tag.outputs.private_tag) || '' }}
            
            ${{ steps.get_tag.outputs.latest_tag != 'none' && steps.check_release.outputs.release_exists == 'false' && steps.create_tag.outputs.tag_success == 'false' && format('  git push origin {0} --force', steps.get_tag.outputs.private_tag) || '' }}
            
            æŸ¥çœ‹è¯¦æƒ…: https://github.com/EightDoor/siyuan/commits/master
            
            ---
            æ³¨æ„ï¼šç‰ˆæœ¬å·æ¥è‡ªä¸Šæ¸¸ tag (v${{ steps.get_tag.outputs.version }}) â†’ ç§æœ‰ tag (${{ steps.get_tag.outputs.private_tag }})
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: Send email notification on conflict
        if: failure() && steps.merge.outputs.merge_success == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ SiYuan ä»£ç åŒæ­¥å†²çª - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            âš ï¸ ä»£ç åŒæ­¥æ—¶æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†ï¼
            
            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            é—®é¢˜: åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯æ—¶å‘ç”Ÿå†²çª
            
            è¯·å°½å¿«æ‰‹åŠ¨è§£å†³å†²çªï¼š
            1. git fetch upstream
            2. git merge upstream/master
            3. è§£å†³å†²çª
            4. git push origin master
            
            æŸ¥çœ‹è¯¦æƒ…: https://github.com/EightDoor/siyuan/actions
            
            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: Send email notification on error
        if: failure() && steps.merge.outputs.merge_success != 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âš ï¸ SiYuan ä»£ç åŒæ­¥å¤±è´¥ - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            ä»£ç åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼
            
            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            
            è¯·æ£€æŸ¥æ—¥å¿—: https://github.com/EightDoor/siyuan/actions
            
            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
