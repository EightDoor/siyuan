name: Sync Upstream

on:
  schedule:
    # æ¯7å¤©åŒ—äº¬æ—¶é—´ 9:00 (UTC 1:00) æ£€æŸ¥æ›´æ–°
    - cron: '0 1 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    name: Sync Upstream Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/siyuan-note/siyuan.git
          git fetch upstream

      - name: Check for updates
        id: check_updates
        run: |
          echo "Checking for updates from upstream..."
          UPSTREAM_LATEST=$(git rev-parse upstream/master)
          CURRENT=$(git rev-parse origin/master)

          if [ "$UPSTREAM_LATEST" = "$CURRENT" ]; then
            echo "âœ… Already up to date"
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”„ New commits found"
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "upstream_latest=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
            echo "current=$CURRENT" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        id: merge
        if: steps.check_updates.outputs.needs_sync == 'true'
        run: |
          echo "Attempting to merge upstream/master into master..."
          if git merge upstream/master -m "Merge upstream/master at $(date +'%Y-%m-%d %H:%M:%S UTC')" --no-edit; then
            echo "âœ… Merge successful"
            echo "merge_success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Merge conflict detected"
            echo "merge_success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Push changes
        if: steps.merge.outputs.merge_success == 'true'
        run: |
          git push origin master
        env:
          # ä½¿ç”¨ PAT ä»¥ä¾¿æ¨é€åŒ…å«å·¥ä½œæµæ–‡ä»¶æ›´æ”¹çš„ä»£ç 
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Get latest upstream tag
        if: steps.merge.outputs.merge_success == 'true'
        id: get_tag
        run: |
          # è·å–æœ€æ–°çš„ä¸Šæ¸¸æ­£å¼ç‰ˆæœ¬ tagï¼ˆæ’é™¤ -dev, -beta, -rc ç­‰åç¼€ï¼‰
          LATEST_TAG=$(git tag -l "v*" --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)

          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ­£å¼ç‰ˆæœ¬ï¼Œåˆ™è·³è¿‡åç»­å¤„ç†
          if [ -z "$LATEST_TAG" ]; then
            echo "â„¹ï¸  No stable release tag found, skipping tag sync..."
            echo "latest_tag=none" >> $GITHUB_OUTPUT
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "is_stable_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Latest upstream stable tag: $LATEST_TAG"
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # æ£€æŸ¥è¯¥ tag æ˜¯å¦å·²å­˜åœ¨äºè¿œç¨‹ä»“åº“
          echo "Checking if tag exists in remote..."
          if git ls-remote --tags origin | grep -q "refs/tags/$LATEST_TAG$"; then
            echo "âš ï¸  Tag $LATEST_TAG already exists in remote, skipping..."
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "is_stable_release=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Tag $LATEST_TAG does not exist in remote, will push..."
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "is_stable_release=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if release exists
        if: steps.get_tag.outputs.tag_exists == 'false' && steps.get_tag.outputs.latest_tag != 'none'
        id: check_release
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          echo "Checking if release exists for tag $LATEST_TAG..."

          # ä½¿ç”¨ GitHub API æ£€æŸ¥ release æ˜¯å¦å­˜åœ¨
          RELEASE_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$LATEST_TAG")

          if echo "$RELEASE_RESPONSE" | grep -q '"tag_name"'; then
            echo "âš ï¸  Release for tag $LATEST_TAG already exists, skipping..."
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Release for tag $LATEST_TAG does not exist, will create..."
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Push new tag to origin
        if: steps.check_release.outputs.release_exists == 'false'
        run: |
          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"
          echo "Checking tag $LATEST_TAG from upstream..."

          # å‰é¢å·²ç» git fetch upstreamï¼Œæ ‡ç­¾å·²åœ¨æœ¬åœ°
          # ç›´æ¥ä½¿ç”¨ä¸Šæ¸¸æ ‡ç­¾æŒ‡å‘çš„ commit åˆ›å»ºæœ¬åœ°æ ‡ç­¾
          UPSTREAM_COMMIT=$(git rev-parse refs/tags/$LATEST_TAG)
          echo "Upstream tag $LATEST_TAG points to commit: $UPSTREAM_COMMIT"

          echo "Deleting local tag $LATEST_TAG if exists..."
          git tag -d "$LATEST_TAG" 2>/dev/null || true

          echo "Creating local tag $LATEST_TAG at commit $UPSTREAM_COMMIT..."
          git tag -f "$LATEST_TAG" "$UPSTREAM_COMMIT"

          echo "Pushing tag $LATEST_TAG to origin..."
          # ä½¿ç”¨ PAT è¿›è¡Œè®¤è¯ï¼Œå› ä¸º tag åŒ…å«å·¥ä½œæµæ–‡ä»¶æ›´æ”¹
          git push https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git "$LATEST_TAG"

          echo "âœ… Tag $LATEST_TAG pushed successfully, this will trigger the build workflow"

      - name: Get current time
        id: time
        run: |
          echo "datetime=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

      - name: Send email notification on success
        if: steps.merge.outputs.merge_success == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… SiYuan ä»£ç åŒæ­¥æˆåŠŸ - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            ä»£ç å·²æˆåŠŸä»ä¸Šæ¸¸åŒæ­¥ï¼

            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            åŠ¨ä½œ: åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯

            Tag çŠ¶æ€:
            ${{ steps.get_tag.outputs.latest_tag == 'none' && 'æœªæ£€æµ‹åˆ°æ­£å¼ç‰ˆæœ¬ tag' || steps.check_release.outputs.release_exists == 'true' && format('æ­£å¼ç‰ˆæœ¬ {0} çš„ Release å·²å­˜åœ¨ï¼Œè·³è¿‡æ„å»º', steps.get_tag.outputs.latest_tag) || steps.get_tag.outputs.tag_exists == 'true' && format('æœ€æ–°æ­£å¼ç‰ˆæœ¬ {0} å·²å­˜åœ¨ï¼Œè·³è¿‡æ¨é€', steps.get_tag.outputs.latest_tag) || format('ğŸ‰ æ­£å¼ç‰ˆæœ¬ {0} å·²æ¨é€ï¼Œå°†è§¦å‘æ„å»º', steps.get_tag.outputs.latest_tag) }}

            æŸ¥çœ‹è¯¦æƒ…: https://github.com/EightDoor/siyuan/commits/master

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: Send email notification on conflict
        if: failure() && steps.merge.outputs.merge_success == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ SiYuan ä»£ç åŒæ­¥å†²çª - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            âš ï¸ ä»£ç åŒæ­¥æ—¶æ£€æµ‹åˆ°å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†ï¼

            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan
            é—®é¢˜: åˆå¹¶ä¸Šæ¸¸ master åˆ†æ”¯æ—¶å‘ç”Ÿå†²çª

            è¯·å°½å¿«æ‰‹åŠ¨è§£å†³å†²çªï¼š
            1. git fetch upstream
            2. git merge upstream/master
            3. è§£å†³å†²çª
            4. git push origin master

            æŸ¥çœ‹è¯¦æƒ…: https://github.com/EightDoor/siyuan/actions

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€

      - name: Send email notification on error
        if: failure() && steps.merge.outputs.merge_success != 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âš ï¸ SiYuan ä»£ç åŒæ­¥å¤±è´¥ - ${{ steps.time.outputs.datetime }}"
          to: 851708184@qq.com
          from: SiYuan Sync Bot
          body: |
            ä»£ç åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼

            æ—¶é—´: ${{ steps.time.outputs.datetime }}
            ä»“åº“: EightDoor/siyuan

            è¯·æ£€æŸ¥æ—¥å¿—: https://github.com/EightDoor/siyuan/actions

            ---
            æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€
